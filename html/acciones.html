<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Filtrar Lotes por Estado</title>
</head>
<body>
    <!-- Select para elegir el estado de los lotes -->
    <select class="input_ingresar input--facturacion" id="estado">
        <option value="" disabled selected >Estado</option>
        <option value="1">Activo</option>
        <option value="0">Inactivo</option>
    </select>

    <!-- Select para los lotes -->
    <select class="input_ingresar input--facturacion" id="lote">
        <!-- Las opciones se agregarán dinámicamente aquí -->
    </select>

    <script>
        // Función para capturar los lotes desde el servidor
        async function obtenerLotes() {
            try {
                // Realizamos la petición al servlet que devuelve los lotes en formato JSON
                const response = await fetch('http://localhost:8080/JSP__proyecto7/ControlReportes?accion=listar');

                // Verificamos si la respuesta es exitosa
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                // Convertimos la respuesta en un objeto JSON
                const lotes = await response.json();

                // Mostramos los datos JSON en la consola
                console.log("Datos recibidos:", lotes);

                // Esperamos a que el usuario seleccione un estado para filtrar los lotes
                document.querySelector('#estado').addEventListener('change', function () {
                    const estadoSeleccionado = this.value; // Obtener el valor seleccionado
                    llenarSelectLotes(lotes, estadoSeleccionado); // Llamar a la función con el estado
                });

            } catch (error) {
                console.error('Error al obtener los lotes:', error);
            }
        }

        // Función para llenar el <select> con los lotes obtenidos según el estado
        function llenarSelectLotes(lotes, estado) {
            const selectLote = document.querySelector('#lote');  // Referencia al select
            const fragmento = document.createDocumentFragment(); // Crear un fragmento para optimizar la inserción en el DOM

            // Limpiar las opciones anteriores del select de lotes
            selectLote.innerHTML = '';

            // Agregar opción por defecto
            let opcionDefault = document.createElement("option");
            opcionDefault.value = '';
            opcionDefault.textContent = 'Seleccione...';
            opcionDefault.disabled = true;
            opcionDefault.selected = true;
            fragmento.appendChild(opcionDefault);

            // Iterar sobre los lotes y crear opciones según el estado seleccionado
            lotes.forEach(lote => {
                if (lote.est == estado) {
                    let option = document.createElement("option");
                    option.value = lote.id;  // El valor del ID del lote
                    option.textContent = "Lote " + lote.num;  // El texto que se mostrará
                    fragmento.appendChild(option);
                }
            });

            // Añadir todas las opciones al select de una sola vez
            selectLote.appendChild(fragmento);
        }

        // Llamar a la función obtenerLotes para llenar el select cuando se cargue la página
        obtenerLotes();
    </script>
</body>
</html>
